# MIA系统架构决策记录 (Architecture Decision Records)

**版本**: v1.0  
**日期**: 2026-01-16  
**目的**: 记录关键架构决策，防止LLM偏离设计意图

---

## ADR-001: 三位一体架构

### 状态
✅ 已采纳

### 背景
需要在单机环境下实现高性能量化交易系统，同时支持多终端访问。

### 决策
采用三位一体架构：
- **The Body (AMD AI Max)**: 全能计算节点
- **The Eye (Client)**: 纯可视化终端
- **The Brain (Cloud API)**: 逻辑外脑

### 理由
1. **性能**: AMD UMA架构提供128GB统一内存，支持零拷贝
2. **灵活性**: Client可以是任意设备（Mac/iPad/iPhone/PC）
3. **可靠性**: Cloud API作为热备，确保高可用

### 约束
- Client端禁止执行计算任务
- 所有AI推理在AMD或Cloud执行
- 热备切换延迟 < 200ms

### 后果
- ✅ 性能最优化
- ✅ 支持多终端
- ⚠️ 需要实现热备切换逻辑

---

## ADR-002: 五态生物钟调度

### 状态
✅ 已采纳

### 背景
单机算力有限，需要在不同时段分配不同任务。

### 决策
实现五态生物钟：
- State 0: 维护态 (Manual)
- State 1: 战备态 (08:30-09:15)
- State 2: 战争态 (09:15-15:00)
- State 3: 诊疗态 (15:00-20:00)
- State 4: 进化态 (20:00-08:30)

### 理由
1. **资源隔离**: 避免推理和训练任务冲突
2. **性能保证**: 战争态独占GPU，确保低延迟
3. **时间利用**: 夜间进行进化和挖掘

### 约束
- 严格按时间切换状态
- 战争态禁止重型I/O
- 进化态独占GPU资源

### 后果
- ✅ 资源利用率最大化
- ✅ 交易时段性能保证
- ⚠️ 需要精确的调度器

---

## ADR-003: SPSC无锁环形队列

### 状态
✅ 已采纳

### 背景
需要在进程间传输高频Tick数据，延迟要求 < 1ms。

### 决策
使用SPSC (Single-Producer Single-Consumer) 无锁环形队列：
- 基于`multiprocessing.shared_memory`
- 原子性校验（Sequence_ID）
- 零拷贝传输

### 理由
1. **性能**: 无锁设计，延迟 < 100μs
2. **安全**: 原子性校验防止脏读
3. **简单**: SPSC模式避免复杂同步

### 约束
- 仅支持单生产者单消费者
- 需要处理撕裂读（Sequence_ID不一致）
- 环形队列大小固定

### 后果
- ✅ 极低延迟
- ✅ 零拷贝
- ⚠️ 需要处理队列满的情况

---

## ADR-004: 双盘物理隔离

### 状态
✅ 已采纳

### 背景
需要保护系统盘，防止数据写入导致系统不稳定。

### 决策
- C盘: 只读系统盘 (`PYTHONDONTWRITEBYTECODE=1`)
- D盘: 读写数据盘 (日志/DB/Docker)

### 理由
1. **稳定性**: 系统盘只读，防止意外写入
2. **性能**: 数据盘可以使用更快的SSD
3. **安全**: 物理隔离，防止数据泄露

### 约束
- 所有数据写入D盘
- C盘仅维护态可写
- 违反触发告警

### 后果
- ✅ 系统稳定性提升
- ✅ 数据安全
- ⚠️ 需要监控写入路径

---

## ADR-005: 热备高可用架构

### 状态
✅ 已采纳

### 背景
AMD驱动可能崩溃，需要确保交易不中断。

### 决策
实现热备切换：
- **Normal Mode**: AMD本地Qwen-30B (延迟 < 20ms)
- **Failover Mode**: DeepSeek-v3.2 API (延迟 < 200ms)
- 通过Redis共享上下文

### 理由
1. **可靠性**: 驱动崩溃不影响交易
2. **性能**: 正常情况下使用本地模型
3. **成本**: 仅故障时使用云端API

### 约束
- 切换延迟 < 200ms
- 上下文同步通过Redis
- 需要监控本地模型健康状态

### 后果
- ✅ 高可用性
- ✅ 成本可控
- ⚠️ 需要实现健康检查

---

## ADR-006: 斯巴达竞技场双轨测试

### 状态
✅ 已采纳

### 背景
需要评估策略在真实和极端场景下的表现。

### 决策
实现双轨压力测试：
- **轨道A (Reality Track)**: 真实历史数据
- **轨道B (Hell Track)**: 极端行情模拟

### 理由
1. **全面性**: 同时考核盈利能力和生存能力
2. **严格性**: 只有通过双轨的策略才能获得Z2H钢印
3. **实用性**: 极端场景测试防止黑天鹅

### 约束
- Reality Track: score > 0.5
- Hell Track: survival_rate > 0.3
- 必须通过双轨才能颁发Z2H钢印

### 后果
- ✅ 策略质量保证
- ✅ 风险可控
- ⚠️ 测试时间较长

---

## ADR-007: 遗传算法因子挖掘

### 状态
✅ 已采纳

### 背景
需要自动发现有效因子，避免人工硬编码。

### 决策
使用遗传算法全量自动挖掘：
- 种群规模: 50-200
- 进化代数: 10-100
- 算子白名单: 50+种安全算子

### 理由
1. **自动化**: 无需人工设计因子
2. **无限空间**: 理论因子空间 > 10^15
3. **持续进化**: 因子随市场环境进化

### 约束
- 仅允许白名单算子
- AST验证防止恶意代码
- 适应度函数多维度评估

### 后果
- ✅ 因子质量高
- ✅ 持续进化
- ⚠️ 计算资源消耗大

---

## ADR-008: 独立审计进程

### 状态
✅ 已采纳

### 背景
需要确保交易记录的准确性和完整性。

### 决策
实现独立审计进程：
- 维护影子账本（Shadow Ledger）
- 交易执行进程无权确认成交
- 实时对账，发现差异立即告警

### 理由
1. **安全性**: 防止执行进程篡改记录
2. **准确性**: 以券商真实持仓为准
3. **可追溯**: 完整审计日志

### 约束
- 每5分钟同步券商持仓
- 发现差异立即告警
- 审计日志不可变

### 后果
- ✅ 资金安全
- ✅ 记录准确
- ⚠️ 需要额外进程

---

## ADR-009: 加密存储敏感信息

### 状态
✅ 已采纳

### 背景
API密钥等敏感信息不能明文存储。

### 决策
使用Fernet对称加密：
- 主密钥存储在D盘（权限600）
- API密钥加密后存储在.env
- 运行时解密使用

### 理由
1. **安全性**: 防止密钥泄露
2. **简单性**: Fernet易于使用
3. **标准化**: 基于AES-128-CBC

### 约束
- 主密钥文件权限必须是600
- 加密密钥不能提交到Git
- 需要安全的密钥管理流程

### 后果
- ✅ 安全性提升
- ✅ 符合安全标准
- ⚠️ 需要密钥管理

---

## ADR-010: 零信任网络架构

### 状态
✅ 已采纳

### 背景
需要保护系统不被公网攻击。

### 决策
使用Tailscale VPN构建私有网络：
- 严禁公网暴露端口
- 所有访问通过VPN隧道
- JWT Token认证

### 理由
1. **安全性**: 零信任架构
2. **简单性**: Tailscale自动组网
3. **灵活性**: 支持多设备访问

### 约束
- 必须通过Tailscale访问
- 防火墙仅允许Tailscale网段
- JWT Token有效期24小时

### 后果
- ✅ 安全性最大化
- ✅ 易于部署
- ⚠️ 依赖Tailscale服务

---

## ADR-011: 数据探针自适应机制

### 状态
✅ 已采纳

### 背景
数据源接口可能失效，需要自动发现和切换。

### 决策
实现数据探针机制：
- 首次启动全量探测
- 生成探针日志（接口清单、质量评分）
- 下载失败自动切换BACKUP接口
- 因子挖掘前检查数据完整性

### 理由
1. **自动化**: 无需人工配置数据源
2. **容错性**: 接口失效自动切换
3. **完整性**: 确保数据最新

### 约束
- 探针日志保留最近3个版本
- 下载日志保留最近30天
- 数据时效性以收盘后为准

### 后果
- ✅ 数据可靠性提升
- ✅ 运维成本降低
- ⚠️ 需要定期探测

---

## ADR-012: 29维度策略深度分析

### 状态
✅ 已采纳

### 背景
需要全面评估策略质量，指导进化方向。

### 决策
实现29个维度的策略分析：
- 16个专业分析器（Phase 5实现）
- 覆盖策略本质、风险、过拟合、市场适配等
- 集成AI三脑（Soldier/Commander/Devil）
- 生成可视化报告

### 理由
1. **全面性**: 覆盖策略评估的所有关键维度
2. **智能化**: 利用LLM进行深度分析
3. **可视化**: 29种图表直观展示

### 约束
- 单个维度分析 < 5秒
- 综合分析 < 30秒
- 过拟合检测准确率 > 90%

### 后果
- ✅ 策略质量提升30%
- ✅ 过拟合率降低50%
- ⚠️ LLM API成本增加

---

## ADR-013: 主力资金深度分析

### 状态
✅ 已采纳

### 背景
需要识别主力行为，提供跟随建议。

### 决策
实现主力资金深度分析：
- 基于Level-2数据识别建仓成本
- 估算主力持股量和盈利水平
- 识别主力类型和行为模式
- 预测下一步动作

### 理由
1. **实用性**: 主力行为是重要信号
2. **准确性**: Level-2数据更精确
3. **可操作**: 提供明确的跟随建议

### 约束
- 分析延迟 < 3秒
- 主力识别准确率 > 70%
- 需要Level-2数据权限

### 后果
- ✅ 跟随成功率 > 70%
- ✅ 交易决策效率提升60%
- ⚠️ 依赖Level-2数据

---

## ADR-014: 个股结论性建议

### 状态
✅ 已采纳

### 背景
需要为用户提供明确的操作建议。

### 决策
实现个股结论性建议引擎：
- 综合所有分析模块
- 提供买入/卖出/持有/观望建议
- 包含置信度、价格目标、仓位建议
- UI醒目展示

### 理由
1. **实用性**: 用户需要明确建议
2. **全面性**: 综合29个维度
3. **可信度**: 提供置信度和理由

### 约束
- 建议生成 < 3秒
- 置信度 > 75%才推荐
- 必须包含风险提示

### 后果
- ✅ 用户体验提升
- ✅ 决策效率提升
- ⚠️ 需要承担建议责任

---

## 决策原则

### 1. 性能优先
- 关键路径延迟 < 20ms
- 战争态独占GPU
- 零拷贝数据传输

### 2. 安全第一
- 零信任架构
- 加密存储敏感信息
- 独立审计进程

### 3. 可靠性保证
- 热备高可用
- 数据探针自适应
- 完整审计日志

### 4. 持续进化
- 遗传算法因子挖掘
- 斯巴达竞技场测试
- 反向学习机制

---

## 变更历史

| 日期 | ADR | 变更内容 | 原因 |
|------|-----|---------|------|
| 2026-01-16 | ADR-001 ~ ADR-014 | 初始版本 | 系统架构设计 |

---

**注意**: 所有架构决策必须经过充分讨论和评审，变更需要更新本文档。
