# MIA风险控制架构配置
# 版本: v1.0
# 日期: 2026-01-21

# ==================== 架构选择 ====================

risk_control:
  # 当前使用的架构: 'soldier_hardcoded' 或 'strategy_layer'
  architecture: 'strategy_layer'  # 默认使用策略层架构（符合白皮书）
  
  # 备用架构（用于对比测试或应急切换）
  fallback_architecture: 'soldier_hardcoded'
  
  # 是否启用双架构对比测试模式
  enable_comparison_mode: false
  
  # 架构切换策略
  auto_switch:
    enabled: false  # 是否启用自动切换
    trigger_conditions:
      sharpe_ratio_threshold: 1.0  # 夏普比率低于此值触发评估
      max_drawdown_threshold: -0.15  # 最大回撤超过此值触发评估
      evaluation_period_days: 7  # 评估周期（天）
      switch_threshold: 0.1  # 另一架构综合评分需优于当前架构10%才切换

# ==================== 架构A: Soldier硬编码风险控制 ====================

soldier_hardcoded:
  # 是否启用此架构
  enabled: false
  
  # 风险评估参数
  risk_assessment:
    # 波动率阈值
    volatility_threshold_low: 0.02  # 低风险波动率阈值（2%）
    volatility_threshold_high: 0.05  # 高风险波动率阈值（5%）
    
    # 流动性阈值
    liquidity_threshold_low: 1000000  # 低风险流动性阈值（100万）
    liquidity_threshold_high: 100000  # 高风险流动性阈值（10万）
    
    # 相关性阈值
    correlation_threshold: 0.7  # 相关性阈值（70%）
    
    # 评估窗口
    assessment_window: 20  # 风险评估窗口（天数）
  
  # 风险控制矩阵
  risk_limits:
    low:
      max_position: 0.95  # 最大总仓位
      single_stock: 0.05  # 单股最大仓位
      industry: 0.30  # 单行业最大仓位
      stop_loss: -0.03  # 止损线
    
    medium:
      max_position: 0.80
      single_stock: 0.03
      industry: 0.20
      stop_loss: -0.05
    
    high:
      max_position: 0.60
      single_stock: 0.02
      industry: 0.15
      stop_loss: -0.08
  
  # 性能配置
  performance:
    cache_ttl: 5  # 决策缓存TTL（秒）
    max_cache_size: 1000  # 最大缓存条目数
    risk_assessment_timeout: 5  # 风险评估超时（秒）

# ==================== 架构B: 策略层风险控制 ====================

strategy_layer:
  # 是否启用此架构
  enabled: true
  
  # 资本分配器配置
  capital_allocator:
    # AUM更新配置
    aum_update_interval: 60  # AUM更新间隔（秒）
    aum_source: 'broker_api'  # AUM数据源: 'broker_api', 'manual', 'calculated'
    
    # 策略再平衡配置
    strategy_rebalance_interval: 3600  # 策略再平衡间隔（秒）
    rebalance_threshold: 0.05  # 权重偏离阈值（5%触发再平衡）
    
    # 资金档位定义（模拟盘4档 + 实盘6档）
    capital_tiers:
      # 模拟盘阶段（Arena测试）
      tier1_micro:
        name: '微型资金档'
        min_aum: 1000
        max_aum: 10000
        mode: 'assassin'  # 刺客模式
        description: '高频、灵活、完全自由进化'
        arena_constraints:
          - 'capital_scale_only'  # 仅资金规模约束
      
      tier2_small:
        name: '小型资金档'
        min_aum: 10000
        max_aum: 100000
        mode: 'assassin'
        description: '均衡、完全自由进化'
        arena_constraints:
          - 'capital_scale_only'
      
      tier3_medium:
        name: '中型资金档'
        min_aum: 100000
        max_aum: 500000
        mode: 'wolf_pack'  # 狼群模式
        description: '分散、完全自由进化'
        arena_constraints:
          - 'capital_scale'
          - 'slippage_simulation'  # 滑点模拟
      
      tier4_large:
        name: '大型资金档'
        min_aum: 500000
        max_aum: 1000000
        mode: 'wolf_pack'
        description: '稳健、完全自由进化'
        arena_constraints:
          - 'capital_scale'
          - 'slippage_simulation'
          - 'impact_cost'  # 冲击成本
      
      # 实盘运行阶段（额外2档）
      tier5_million:
        name: '百万级资金档'
        min_aum: 1000000
        max_aum: 10000000
        mode: 'leviathan'  # 利维坦模式
        description: '低频、流动性约束'
        constraints:
          - 'arena_evolved_params'  # 使用Arena进化参数
          - 'enhanced_liquidity_constraint'  # 增强流动性约束
      
      tier6_ten_million:
        name: '千万级资金档'
        min_aum: 10000000
        max_aum: null  # 无上限
        mode: 'leviathan'
        description: '超低频、严格流动性约束'
        constraints:
          - 'arena_evolved_params'
          - 'strict_liquidity_constraint'  # 严格流动性约束
          - 'twap_vwap_execution'  # TWAP/VWAP执行
  
  # 策略风险管理器配置
  strategy_risk_manager:
    # 是否使用Arena进化出的参数
    use_arena_evolved_params: true
    
    # 默认风险参数（Arena未完成时使用）
    default_params:
      max_position: 0.80  # 最大总仓位
      stop_loss_pct: -0.05  # 止损百分比
      take_profit_pct: 0.10  # 止盈百分比
      max_single_stock: 0.03  # 单股最大仓位
      max_industry: 0.20  # 单行业最大仓位
      liquidity_threshold: 100000  # 流动性阈值
      trailing_stop_enabled: true  # 是否启用移动止损
    
    # 流动性管理
    liquidity_management:
      min_daily_volume: 1000000  # 最小日成交量
      max_order_volume_ratio: 0.05  # 单笔订单不超过日成交量的5%
      split_large_orders: true  # 是否拆分大单
      use_twap_threshold: 1000000  # 超过此金额使用TWAP
      use_vwap_threshold: 5000000  # 超过此金额使用VWAP
    
    # 止损策略
    stop_loss_strategies:
      fixed_stop_loss:
        enabled: true
        default_pct: -0.05
      
      trailing_stop_loss:
        enabled: true
        trail_pct: 0.03  # 回撤3%触发
      
      time_stop_loss:
        enabled: true
        max_holding_days: 30  # 最长持仓天数
      
      volatility_stop_loss:
        enabled: true
        volatility_multiplier: 2.0  # 2倍ATR止损
    
    # 止盈策略
    take_profit_strategies:
      fixed_take_profit:
        enabled: true
        default_pct: 0.10
      
      trailing_take_profit:
        enabled: true
        trail_pct: 0.05
      
      target_return:
        enabled: true
        target_pct: 0.15  # 目标收益15%

# ==================== 元学习配置 ====================

meta_learning:
  # 是否启用元学习
  enabled: true
  
  # 学习阶段配置
  phases:
    phase1_parallel_run:
      name: '并行运行阶段'
      duration_months: 3
      target_samples: 1000
      execution_mode: 'conservative'  # conservative, aggressive, balanced
      description: '同时运行架构A和架构B，收集对比数据'
    
    phase2_intelligent_switch:
      name: '智能切换阶段'
      duration_months: 3
      target_samples: 5000
      high_confidence_threshold: 0.8
      low_confidence_threshold: 0.6
      description: '根据元学习器预测，智能选择风控架构'
    
    phase3_hybrid_evolution:
      name: '混合进化阶段'
      duration_months: 6
      target_samples: 10000
      hybrid_rules_enabled: true
      description: '融合两种架构，进化出混合策略'
    
    phase4_continuous_optimization:
      name: '持续优化阶段'
      duration_months: null  # 无限期
      target_samples: 20000
      auto_evolution_enabled: true
      description: '持续学习和优化，自动进化新策略'
  
  # 当前阶段
  current_phase: 'phase1_parallel_run'
  
  # 元学习器配置
  meta_learner:
    # 模型配置
    model_type: 'random_forest'  # random_forest, xgboost, neural_network
    model_params:
      n_estimators: 100
      max_depth: 10
      random_state: 42
    
    # 训练配置
    training:
      min_samples: 50  # 最少样本数才开始训练
      retrain_interval: 100  # 每100个样本重新训练
      validation_split: 0.2  # 验证集比例
    
    # 特征工程
    features:
      - 'volatility'
      - 'liquidity'
      - 'trend_strength'
      - 'regime'
      - 'aum'
      - 'portfolio_concentration'
      - 'recent_drawdown'
    
    # 性能评估
    evaluation:
      metrics:
        - 'accuracy'
        - 'precision'
        - 'recall'
        - 'f1_score'
      target_accuracy: 0.70  # 目标准确率
  
  # 智能路由器配置
  intelligent_router:
    high_confidence_threshold: 0.8
    low_confidence_threshold: 0.6
    fallback_strategy: 'hardcoded'  # 低置信度时的回退策略
  
  # 混合风控配置
  hybrid_risk_control:
    # 混合策略规则
    rules:
      - name: 'high_volatility_conservative'
        condition: 'volatility > 0.30'
        action: 'increase_hardcoded_weight'
        weight_adjustment: 0.3
        reason: '高波动环境，增加保守风控权重'
      
      - name: 'large_aum_flexible'
        condition: 'aum > 1000000'
        action: 'increase_strategy_layer_weight'
        weight_adjustment: 0.2
        reason: '大资金规模，增加灵活风控权重'
      
      - name: 'large_drawdown_conservative'
        condition: 'recent_drawdown < -0.10'
        action: 'use_hardcoded_only'
        weight_adjustment: 1.0
        reason: '回撤过大，切换到保守风控'
      
      - name: 'strong_trend_aggressive'
        condition: 'abs(trend_strength) > 0.7'
        action: 'increase_strategy_layer_weight'
        weight_adjustment: 0.25
        reason: '趋势明确，增加激进风控权重'
      
      - name: 'low_liquidity_conservative'
        condition: 'liquidity < 500000'
        action: 'increase_hardcoded_weight'
        weight_adjustment: 0.2
        reason: '流动性不足，增加保守风控权重'
    
    # 默认权重
    default_weights:
      architecture_a: 0.5
      architecture_b: 0.5
  
  # 学习数据存储配置
  data_storage:
    data_dir: 'data/learning'
    retention_days: 365  # 数据保留天数
    auto_archive: true  # 自动归档
    compression: 'gzip'  # 压缩格式
    auto_cleanup: true  # 自动清理过期数据
    cleanup_interval_days: 30  # 清理间隔
  
  # 进化配置
  evolution:
    enabled: true
    evolution_interval: 100  # 每100个样本进化一次
    min_samples_for_evolution: 100
    max_hybrid_strategies: 10  # 最多保留10个混合策略
    strategy_evaluation_period: 30  # 策略评估周期（天）

# ==================== 对比测试配置 ====================

comparison_test:
  # 是否启用对比测试
  enabled: false
  
  # 测试配置
  test_config:
    duration_days: 30  # 对比测试持续天数
    initial_capital: 100000  # 初始资金
    test_mode: 'paper_trading'  # 测试模式: 'paper_trading', 'backtest'
  
  # 评估指标
  metrics:
    - 'sharpe_ratio'  # 夏普比率
    - 'max_drawdown'  # 最大回撤
    - 'win_rate'  # 胜率
    - 'profit_factor'  # 盈亏比
    - 'decision_latency'  # 决策延迟
    - 'total_return'  # 总收益率
    - 'volatility'  # 波动率
    - 'calmar_ratio'  # 卡玛比率
  
  # 报告配置
  report:
    output_path: 'backups/comparison_reports/'
    generate_html: true  # 生成HTML报告
    generate_json: true  # 生成JSON报告
    generate_csv: true  # 生成CSV数据
    auto_email: false  # 是否自动发送邮件
    email_recipients: []
  
  # 决策标准
  decision_criteria:
    # 综合评分权重
    weights:
      sharpe_ratio: 0.40  # 夏普比率权重40%
      max_drawdown: 0.30  # 最大回撤权重30%
      win_rate: 0.20  # 胜率权重20%
      profit_factor: 0.10  # 盈亏比权重10%
    
    # 显著性阈值
    significance_threshold: 0.10  # 需优于当前架构10%才认为显著

# ==================== 监控和告警 ====================

monitoring:
  # 性能监控
  performance_monitoring:
    enabled: true
    check_interval: 300  # 检查间隔（秒）
    
    # 性能指标阈值
    thresholds:
      decision_latency_p99: 100  # P99延迟阈值（毫秒）
      cache_hit_rate: 0.30  # 缓存命中率阈值
      error_rate: 0.01  # 错误率阈值
  
  # 风险监控
  risk_monitoring:
    enabled: true
    check_interval: 60  # 检查间隔（秒）
    
    # 风险指标阈值
    thresholds:
      portfolio_var_95: -0.05  # 95% VaR阈值
      portfolio_concentration: 0.30  # 组合集中度阈值
      leverage_ratio: 1.0  # 杠杆率阈值
  
  # 告警配置
  alerts:
    enabled: true
    channels:
      - 'log'  # 日志
      - 'email'  # 邮件（需配置）
      - 'webhook'  # Webhook（需配置）
    
    # 告警级别
    levels:
      critical:
        - 'system_failure'
        - 'risk_limit_breach'
      warning:
        - 'performance_degradation'
        - 'cache_miss_high'
      info:
        - 'architecture_switch'
        - 'rebalance_triggered'

# ==================== 日志配置 ====================

logging:
  level: 'INFO'  # 日志级别: DEBUG, INFO, WARNING, ERROR, CRITICAL
  
  # 日志输出
  handlers:
    console:
      enabled: true
      level: 'INFO'
    
    file:
      enabled: true
      level: 'DEBUG'
      path: 'logs/risk_control/'
      rotation: 'daily'  # 日志轮转: daily, weekly, size
      max_size_mb: 100
      backup_count: 30
    
    structured:
      enabled: true
      format: 'json'
      path: 'logs/risk_control/structured/'
  
  # 审计日志
  audit:
    enabled: true
    path: 'logs/risk_control/audit/'
    events:
      - 'architecture_switch'
      - 'risk_limit_change'
      - 'strategy_selection'
      - 'capital_reallocation'

# ==================== 高级配置 ====================

advanced:
  # 实验性功能
  experimental:
    enabled: false
    features:
      - 'ml_risk_prediction'  # 机器学习风险预测
      - 'adaptive_risk_limits'  # 自适应风险限制
      - 'multi_objective_optimization'  # 多目标优化
  
  # 调试模式
  debug:
    enabled: false
    verbose_logging: false
    save_decision_history: true
    decision_history_path: 'debug/decision_history/'
  
  # 性能优化
  optimization:
    enable_caching: true
    enable_parallel_processing: true
    max_workers: 4
    use_gpu_acceleration: false  # 是否使用GPU加速（需要支持）
